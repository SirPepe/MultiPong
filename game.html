<!DOCTYPE html>
<html>
<head>
    <title>Hallo</title>

    <style>
        .paddle {
            width: 20px;
            height: 80px;
            background: black;
            position: absolute;
        }

        #player0 {
            left: 0;
            margin-left: 5px;
        }

        #player1 {
            right: 0;
            margin-right: 5px;
        }

        #playground {
            background: green;
            border: 2px solid white;
            width: 900px;
            position: relative;
            height: 680px;
        }

        #ball {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 10px;
            border: 1px solid white;
            position: absolute;
            left: 50%;
            top: 50%;
        }
        .gameOver{

            font-size: 64px;
            font-weight: bold;

            color: white;
            text-align: center;
            width: 100%;
            font-family: Verdana, sans-serif;

        }

    </style>
    <script src="http://code.jquery.com/jquery-2.0.2.min.js"></script>
</head>
<body>
<div id="playground">
    <div id="player0" class="paddle"></div>
    <div id="player1" class="paddle"></div>
    <div id="ball"></div>
</div>
<label>Player 0:</label><input type="range" min="-1" max="1" step="0.02" id="player0-control"
                               onchange="server.trigger(0, $('#player0-control').val())">
<label>Player 1:</label><input type="range" min="-1" max="1" step="0.02" id="player1-control"
                               onchange="server.trigger(1, $('#player1-control').val())">
<script>

    var gameEngine = {
        playerInputPositions: [0, 0],
        player0: {ready: false, elementId: "player0", id : 0},
        player1: {ready: false, elementId: "player1", id : 1},
        ball: {x: 2, y: 2, elementId: "ball"},
        ready: true,
        movePaddles: function () {
            var $playGround = $("#playground");
            var $player0 = $("#" + this.player0.elementId);
            var $player1 = $("#" + this.player1.elementId);
            this.movePaddle($player0, $playGround, this.playerInputPositions[0]);
            this.movePaddle($player1, $playGround, this.playerInputPositions[1]);
        },
        movePaddle: function ($paddle, $playGround, additionalPos) {
            var position = $paddle.position();
            var offset = additionalPos * 7;
            if (position.top + offset <= $playGround.height() - $paddle.height() && position.top + offset >= 0) {
                $paddle.css("top", (position.top + offset) + "px");
            }
        },
        collision: function ($player, position, $ball, $playGround) {
            var pBottom = $player.position().top;
            var pTop = pBottom + $player.height();
            var center = position.top + ($ball.height() / 2);
            if (center > pBottom && pTop > center) {
                this.ball.x = (-1) * this.ball.x;
                return true;
            }
            else {
                $playGround.prepend("<div class='gameOver'>Game Over</div>");
                $ball.hide();
                return false;
            }
        }, moveBall: function () {
            if (this.ready) {
                var $playGround = $("#playground");
                var $ball = $("#" + this.ball.elementId);
                var position = $ball.position();

                if (position.top + this.ball.y < 0 || position.top + this.ball.y > $playGround.height() - $ball.height()) {
                    this.ball.y = (-1) * this.ball.y;
                }
                var newY = position.top + this.ball.y;

                var $player0 = $("#" + this.player0.elementId);
                var $player1 = $("#" + this.player1.elementId);

                if (position.left + this.ball.x <= $player0.width() + 5) {
                    this.ready = this.collision($player0, position, $ball, $playGround);
                    if(!this.ready){
                        server.postGameOver(player1.id)
                    }
                }

                if (position.left + this.ball.x > $playGround.width() - $ball.width() - $player1.width() - 5) {
                    this.ready = this.collision($player1, position, $ball, $playGround);
                    if(!this.ready){
                        server.postGameOver(player0.id)
                    }
                }

                var newX = position.left + this.ball.x;

                $ball.css({"left": newX + "px", "top": newY + "px"});
            }


        }


    };


    window.requestAnimationFrame(function move() {
        gameEngine.movePaddles();
        gameEngine.moveBall();
        window.requestAnimationFrame(move);

    });

    var server = {
        callback: [],
        cbGameOver: [],
        onPosition: function (callback) {
            this.callback.push(callback);
        },
        postGameOver: function (player) {
            console.log("server game over", player);
        },
        trigger: function (player, position) {
            for (var i = 0; i < this.callback.length; i++) {
                this.callback[i](player, position);
            }
        }

    };

    server.onPosition(function (player, position) {
        gameEngine.playerInputPositions[player] = position;
    });

    server.onPosition(function (player, position) {
        gameEngine.playerInputPositions[player] = position;
    });
</script>

</body>
</html>